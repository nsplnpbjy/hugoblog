---
title: "家庭影音套件"
description: 
date: 2025-11-06T12:25:27+08:00
image: https://picsum.photos/800/600.webp?random=147981e4
math: 
license: 
hidden: false
comments: true
draft: false
toc : true
lastmod :
tags: 
categories:
---

# 全自动家庭影音中心部署教程（中国大陆网络环境专用）

## 全流程：
**prowlarr种子索引搜索器，在prowlarr里面配置好radarr和sonarr，prowlarr将自动推送种子索引给radarr和sonarr。**

**sonarr和radarr分别是电视剧和电影整理中心，在里面要配置好下载工具，利用prowlarr推送来的种子索引，向下载工具发出下载命令，并且整理好剧集信息分类存放**

**qBittorrent是下载工具，这个工具也可以是其他的，接收下载指令并执行下载**

**配置从属关系：prowlarr配置radarr和sonarr，radarr和sonarr配置qBittorrent。**

**jellyfin是局域网影音中心，与上面的所有软件都无关，只要硬盘里有就可以放。**

# **所有软件都通过docker来启动，要注意三个重要情况：**

**1.prowlarr不翻墙效果不好，所以要在docker文件设置好代理。**

**2.prowlarr要与radarr和sonarr交互，所以docker文件设置的流量要细分，不能所有流量都翻墙，要不然访问不到radarr和sonarr。**

**3.要给qBittorrent准备一个下载目录比如/downloads，这个目录里面的东西下载好后会被radarr和sonarr自动拿去对应分给radarr和sonarr的目录**

**目标**：  
实现 **搜种走代理 → 下载直连满速 → 自动整理 → Jellyfin 多用户播放** 的完整闭环。  
**核心组件**：`Jellyfin` + `Sonarr` + `Prowlarr` + `qBittorrent`  
**特别适配**：防火墙、代理坑、权限问题、容器名、API 503/404、**服务间连接** 等全场景。

---

## 一、系统架构总览

| 组件            | 功能              | 端口 | 容器名        | 是否走代理  | 挂载路径                              |
| --------------- | ----------------- | ---- | ------------- | ----------- | ------------------------------------- |
| **Jellyfin**    | 媒体播放          | 8096 | `jellyfin`    | 不走        | `/mnt/media/影视`                     |
| **Sonarr**      | 自动追剧          | 8989 | `sonarr`      | 不走        | `/tv` → `/mnt/media/影视/电视剧`      |
| **Prowlarr**    | 搜种（PT/公开站） | 9696 | `prowlarr`    | **走 7890** | `/config`                             |
| **qBittorrent** | BT 下载           | 8080 | `qbittorrent` | **直连**    | `/downloads` → `/mnt/media/downloads` |

> **Radarr（电影）可选**，可后续添加或删除。



## 二、环境与硬件准备

### 1. 系统要求
- Ubuntu 22.04+（推荐服务器版）
- Docker + Docker Compose 已安装
- 硬盘挂载到 `/mnt/media`

```bash
# 查看硬盘
lsblk

# 创建目录
sudo mkdir -p /mnt/media/{影视/电视剧,影视/电影,downloads,照片}
```

### 2. 硬盘自动挂载（`/etc/fstab`）

```bash
# 示例：UUID=xxxx 的盘挂载到 /mnt/media
sudo blkid
# 记录 UUID
sudo nano /etc/fstab
```

```
UUID=你的UUID /mnt/media ext4 defaults 0 2
```

```bash
sudo mount -a
```

---

## 三、Jellyfin 部署（多用户 + 自动扫描）

### 1. 创建目录

```bash
mkdir -p ~/jellyfin/{config,cache}
```

### 2. `docker-compose.yml`

```yaml
services:
  jellyfin:
    image: linuxserver/jellyfin:latest
    container_name: jellyfin
    user: 1000:1000
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Asia/Shanghai
    volumes:
      - ./config:/config
      - ./cache:/cache
      - /mnt/media/影视:/data/影视
      - /mnt/media/照片:/data/照片
      - /mnt/media/downloads:/data/downloads
    ports:
      - 8096:8096
    restart: unless-stopped
```

### 3. 启动与设置

```bash
cd ~/jellyfin
docker compose up -d
```

- 浏览器打开 `http://你的IP:8096`
- 设置管理员账户
- **添加媒体库**：
  - 路径：`/data/影视/电视剧` → 类型：**电视剧**
  - 路径：`/data/影视/电影` → 类型：**电影**
- **启用实时监控**：`Settings → Library → 启用`

### 4. 多用户管理

```
仪表盘 → 用户 → + 添加用户
→ 勾选允许访问的媒体库
```

---

## 四、自动下载系统部署（arr 套件）

### 1. 创建目录

```bash
mkdir -p ~/arr/{qbittorrent,prowlarr,sonarr}
```

### 2. `docker-compose.yml`（**重点：代理 + NO_PROXY + 固定容器名**）

```yaml
services:
  qbittorrent:
    image: linuxserver/qbittorrent:latest
    container_name: qbittorrent
    user: 1000:1000
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Asia/Shanghai
      - WEBUI_PORT=8080
    volumes:
      - ./qbittorrent:/config
      - /mnt/media/downloads:/downloads
    ports:
      - 8080:8080
      - 6881:6881
      - 6881:6881/udp
    restart: unless-stopped

  prowlarr:
    image: linuxserver/prowlarr:latest
    container_name: prowlarr
    user: 1000:1000
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Asia/Shanghai
      # ↓↓↓ 搜种走代理，内部通信绕过 ↓↓↓
      - HTTP_PROXY=http://192.168.1.7:7890
      - HTTPS_PROXY=http://192.168.1.7:7890
      - NO_PROXY=localhost,127.0.0.1,sonarr,qbittorrent,prowlarr
    volumes:
      - ./prowlarr:/config
    ports:
      - 9696:9696
    restart: unless-stopped

  sonarr:
    image: linuxserver/sonarr:latest
    container_name: sonarr
    user: 1000:1000
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Asia/Shanghai
    volumes:
      - ./sonarr:/config
      - /mnt/media/影视/电视剧:/tv
      - /mnt/media/downloads:/downloads
    ports:
      - 8989:8989
    restart: unless-stopped
```

> **Radarr 可选**，不想追电影可删除整个 `radarr:` 块。

### 3. 启动系统

```bash
cd ~/arr
docker compose up -d
```

### 4. 防火墙放行

```bash
sudo ufw allow 8080,9696,8989,6881/tcp
sudo ufw allow 6881/udp
sudo ufw reload
```

---

## 五、关键配置与坑点详解

### 1. **qBittorrent 登录密码**

```bash
docker compose logs qbittorrent | grep -i password
# 输出：Temporary password for 'admin': xxxxx
```

- 浏览器打开 `http://你的IP:8080`
- 用户名：`admin`
- 密码：日志中的临时密码
- **登录后立即修改密码** → `Tools → Options → Web UI`
- **重启容器**：

```bash
docker compose restart qbittorrent
```

---

### 2. **Prowlarr 添加索引器**

| 站点               | 类型    | URL                        | API Key      |
| ------------------ | ------- | -------------------------- | ------------ |
| **1337x**          | Torznab | `https://1337x.to`         | 留空         |
| **M-Team**         | Torznab | `https://tp.m-team.cc`     | 个人 API Key |
| **The Pirate Bay** | Torznab | `https://thepiratebay.org` | 留空         |

> **Test 失败？** → 部署 **FlareSolverr**（反 Cloudflare）

```yaml
  flaresolverr:
    image: flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    ports:
      - 8191:8191
    restart: unless-stopped
```

```bash
docker compose up -d flaresolverr
```

Prowlarr → `Settings → Indexers → 启用 FlareSolverr`

---

## 六、服务间连接配置（核心！）

### 1. **Sonarr → qBittorrent（下载客户端）**

1. 打开 `http://你的IP:8989` → `Settings → Download Clients`
2. **+ 添加 → qBittorrent**
3. 填写：
   - **Name**: `qBittorrent`
   - **Host**: `qbittorrent`（**容器名**）
   - **Port**: `8080`
   - **Username**: 你在 qBittorrent 改的用户名
   - **Password**: 你改的密码
   - **Category**: `sonarr`（可选）
4. **Test → 绿色勾 → Save**

---

### 2. **Prowlarr → Sonarr（应用同步）**

1. **Sonarr 获取 API Key**：
   - `http://你的IP:8989` → `Settings → General → API Key` → 复制
2. **Prowlarr 配置**：
   - `http://你的IP:9696` → `Settings → Apps → + 添加`
   - **Name**: `Sonarr`
   - **Sync App**: `Sonarr`
   - **URL**: `http://sonarr:8989`（**容器名**）
   - **API Key**: 粘贴
   - **Sync Level**: `Full Sync`
   - **先不要 Test，保存**

---

### 3. **突破 Prowlarr Test 503 死循环（最大坑！）**

**原因**：Sonarr 无启用的索引器 → `/api/v3/indexer/schema` 返回 503  
**解决**：**Prowlarr 先加索引器 → 强制同步 → 重启 Sonarr**

```bash
# 1. Prowlarr → 添加 1337x → 保存
# 2. Prowlarr → Apps → Sonarr → 点击 "Sync App Indexers"
# 3. 重启 Sonarr
docker compose restart sonarr
# 4. 等 60 秒 → Prowlarr → Test Sonarr → 绿色
```

> **临时绕过**：Test 失败时，把 URL 改成 `http://你的IP:8989` → Test → 绿色 → 出现 Sync 按钮 → Sync → 改回 `http://sonarr:8989` → 再 Test

---

### 4. **代理劫持内部通信（最大坑！）**

```yaml
# 错误：所有流量走代理
HTTP_PROXY=http://192.168.1.7:7890

# 正确：内部通信绕过
NO_PROXY=sonarr,qbittorrent,prowlarr,localhost,127.0.0.1
```

---

### 5. **容器名问题**

```bash
docker compose ps
```

- 如果显示 `arr-sonarr-1` → URL 改为 `http://arr-sonarr-1:8989`
- **推荐**：在 `docker-compose.yml` 加 `container_name: sonarr`

---

### 6. **权限问题（启动失败）**

```bash
# 容器报错：Could not create directory
sudo chown -R $USER:$USER ~/arr/*
docker compose up -d
```

---

## 七、自动流程验证

1. **Sonarr** → `Search` → 输入 `Friends` → 添加
2. 选一集 → `Manual Search`
3. 选种 → `Download`
4. **qBittorrent** 开始下载
5. 下载完 → 自动重命名 + 移动到 `/mnt/media/影视/电视剧/Friends/Season 1/`
6. **Jellyfin** 自动扫描 → 网页出现

---

## 八、常见问题速查表

| 问题                   | 原因            | 解决                         |
| ---------------------- | --------------- | ---------------------------- |
| WebUI 进不去           | 防火墙          | `ufw allow 端口`             |
| qBittorrent 密码不对   | 临时密码        | `docker logs` 查看           |
| Prowlarr Test 503      | Sonarr 无索引器 | Prowlarr Sync + 重启         |
| Prowlarr 连不上 Sonarr | 代理劫持        | 加 `NO_PROXY`                |
| Sonarr 搜不到种        | 索引器未同步    | Prowlarr → Sync App Indexers |
| 文件名乱码             | 非标准命名      | Sonarr 自动重命名            |
| Jellyfin 不更新        | 没开实时监控    | `Settings → Library` 勾选    |
| 容器名不对             | 项目名影响      | 加 `container_name`          |

---

## 九、终极命令合集

```bash
# 启动
cd ~/arr && docker compose up -d

# 查看日志
docker compose logs sonarr

# 重启
docker compose restart sonarr

# 权限修复
sudo chown -R $USER:$USER ~/arr/*

# 防火墙
sudo ufw allow 8080,9696,8989,6881/tcp
sudo ufw allow 6881/udp
```

---

## 十、后续优化建议

| 功能         | 操作                                   |
| ------------ | -------------------------------------- |
| **硬链接**   | Sonarr → Media Management → 启用       |
| **SMB 共享** | 手机用 nPlayer 播放                    |
| **手机 App** | Swiftfin / Jellyfin for Android        |
| **备份**     | `cp -r ~/arr ~/backup_arr_$(date +%F)` |

---

## 十一、总结：你已拥有

- **搜种翻墙，下载满速**
- **自动追剧 + 整理**
- **Jellyfin 多用户播放**
- **硬盘永不丢失**
- **一键重启恢复**

---

**作者**：Grok（基于用户 `comradegenrr` 真实部署经验）  
**日期**：2025-11-06  
**版本**：v1.1（新增服务间连接章节）

> **有任何问题，贴日志或截图，我秒解！**